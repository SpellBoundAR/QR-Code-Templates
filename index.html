<!DOCTYPE html>
<html>
<body>

<h1>QR Code Inserter</h1>

<div id="documentSetup" class="container">
	<p><b>Document Setup</b></p>
	<label for="documentWidth">Width</label><br>
	<input type="number" step="0.01" min="0" id="documentWidth"><br>
	<label for="documentHeight">Height</label><br>
	<input type="number" step="0.01" min="0" id="documentHeight"><br>
	<input type="file" id="file" name="file" onchange="refreshTemplate()"><br>
</div>

<div id="variants" class="container">
	<p><b>Variants</b></p>
	<input id="rawDataInput" type="text">
	<button type="button" onclick="parseRawData()">Parse Raw Data</button><br><br>
	<button type="button" onclick="addVariant(null, null)">Add Export Variant</button>
	<button type="button" onclick="download()">Download All</button>
</div>

<div id="qrCodePlacements" class="container">
	<p><b>Placements</b></p>
	<button type="button" onclick="addQRCode()">Add QR Code Placement</button><br>
</div>

<div id="page">
	<img id="preview" src="" alt="Image preview...">
</div>

<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>

<style>
	
	.container
	{
		background: #ddd;
		padding: 15px;
		margin: 15px;
	}

	.qrCodeContainer
	{
		background: #eee;
		padding: 8px;
		margin: 8px;
	}

	.column
	{
		float: left;
		width: 50%;
	}

	.row:after
	{
		content: "";
		display: table;
		clear: both;
	}

	.qr-source-container
	{
		display: none;
	}

	.qrCode
	{
		position: relative;
	}

	input
	{
		min-width: 600px;
	}

	#page
	{
		position: relative;
		border: 1px solid black;
		width: 11in;
		height: 8in;
	}

	#preview
	{
		position: relative;
		width: 100%;
		height: 100%;
	}

</style>

<script type="text/javascript">

	document.getElementById('documentWidth').value = 8.5;
	document.getElementById('documentHeight').value = 11;

	let variants = 0;
	let qrCodes = 0;

	function parseRawData()
	{
		let rawData = document.getElementById('rawDataInput').value;
		let rows = rawData.split(', ');
		for (i=0; i < rows.length; i++) {
			rows[i] = rows[i].split(',');
			addVariant(rows[i][0], rows[i][1]);
		}
	}

	function addVariant(name, data)
	{
		variants++;
		let id = variants;

		let div = document.createElement('div');
		div.id = "variant-" + id;
		div.classList.add('qrCodeContainer');
		div.classList.add('row');

		let leftColumn = document.createElement('div');
		leftColumn.classList.add('column');
		div.appendChild(leftColumn);

		let nameLabel = document.createElement('label');
		nameLabel.for = "variant-" + id + "-name"
		nameLabel.innerHTML = "Name";
		leftColumn.appendChild(nameLabel);

		let nameInput = document.createElement('input');
		nameInput.id = "variant-" + id + "-name";
		nameInput.type = "text";
		nameInput.value = name;
		leftColumn.appendChild(nameInput);

		leftColumn.appendChild(document.createElement('br'));

		let dataLabel = document.createElement('label');
		dataLabel.for = "variant-" + id + "-data"
		dataLabel.innerHTML = "Data";
		leftColumn.appendChild(dataLabel);

		let dataInput = document.createElement('input');
		dataInput.id = "variant-" + id + "-data";
		dataInput.type = "text";
		dataInput.value = data;
		dataInput.onchange = function() { generate(id); };
		leftColumn.appendChild(dataInput);

		let rightColumn = document.createElement('div');
		rightColumn.classList.add('column');
		div.appendChild(rightColumn);

		let sourceDiv = document.createElement('div');
		sourceDiv.id = "variant-" + id + "-source";
		sourceDiv.classList.add('qr-source-container');
		rightColumn.appendChild(sourceDiv);

		document.getElementById('variants').appendChild(div);
	}

	function addQRCode()
	{
		qrCodes++;
		let id = qrCodes;

		let div = document.createElement('div');
		div.id = "qrCodePlacement-" + id;
		div.classList.add('qrCodeContainer');

		let sizeLabel = document.createElement('label');
		sizeLabel.for = "qrCodeSize-" + id;
		sizeLabel.innerHTML = "Size:";
		div.appendChild(sizeLabel);

		let sizeInput = document.createElement('input');
		sizeInput.id = "qrCodeSize-" + id;
		sizeInput.type = "number";
		sizeInput.step = 0.01;
		sizeInput.min = 0;
		sizeInput.onchange = function() { refresh(); };
		div.appendChild(sizeInput);

		div.appendChild(document.createElement('br'));

		let xLabel = document.createElement('label');
		xLabel.for = "qrCodeX-" + id;
		xLabel.innerHTML = "X:";
		div.appendChild(xLabel);

		let xInput = document.createElement('input');
		xInput.id = "qrCodeX-" + id;
		xInput.type = "number";
		xInput.step = 0.01;
		xInput.min = 0;
		xInput.onchange = function() { refresh(); };
		div.appendChild(xInput);

		div.appendChild(document.createElement('br'));

		let yLabel = document.createElement('label');
		yLabel.for = "qrCodeY-" + id;
		yLabel.innerHTML = "Y:";
		div.appendChild(yLabel);

		let yInput = document.createElement('input');
		yInput.id = "qrCodeY-" + id;
		yInput.type = "number";
		yInput.step = 0.01;
		yInput.min = 0;
		yInput.onchange = function() { refresh(); };
		div.appendChild(yInput);

		document.getElementById('qrCodePlacements').appendChild(div);
	}

	function generate(id)
	{
		let dataID = "variant-" + id + "-data";
		let data = document.getElementById(dataID).value;
		let parentID = "variant-" + id + "-source";

		var parent = document.getElementById(parentID);
		parent.innerHTML = "";

		let qrCodeRaw = new QRCode(parent, {
			text: data,
			width: 256,
			height: 256,
			colorDark : "#111",
			colorLight : "#fff",
			correctLevel : QRCode.CorrectLevel.H
		});
	}

	function refreshTemplate()
	{
		var preview = document.getElementById('preview');
		var file    = document.querySelector('input[type=file]').files[0];
		var reader  = new FileReader();

		reader.onloadend = function ()
		{
			preview.src = reader.result;
		}

		if (file)
		{
			reader.readAsDataURL(file);
		} 
		else preview.src = "";
	}

	function refresh()
	{
		let documentWidth = parseFloat(document.getElementById('documentWidth').value);
		let documentHeight = parseFloat(document.getElementById('documentHeight').value);

		let page = document.getElementById("page")
		page.style.width = documentWidth + "in";
		page.style.height = documentHeight + "in";

		for (let i = 1; i < qrCodes + 1; i++)
		{
			let id = "qrCode-" + i;
			var element = document.getElementById(id);
			if (element !== null && element !== undefined)
			{
				element.parentNode.removeChild(element);
			}
		}

		for (let i = 1; i < qrCodes + 1; i++)
		{
			let id = "qrCode-" + i;
			let content = '<div id="' + id + '" style="background: #f00;"></div>';
			let size = document.getElementById('qrCodeSize-' + i).value;
			let x = document.getElementById('qrCodeX-' + i).value;
			let y = document.getElementById('qrCodeY-' + i).value;
			document.getElementById('page').innerHTML += content;
			document.getElementById(id).style.position = "absolute";
			document.getElementById(id).style.left = x + "in";
			document.getElementById(id).style.top = y + "in";
			document.getElementById(id).style.width = size + "in";
			document.getElementById(id).style.height = size + "in";
		}
	}

	function download()
	{
		let template = new Image();
		template.src = document.getElementById('preview').getAttribute("src");
		let templateFileType = template.src.split('.').pop();

		for (let i = 1; i < variants + 1; i++)
		{
			let qrcode = new Image();
			qrcode.src = document.querySelector('#variant-' + i + '-source img').getAttribute("src");

			let documentWidth = parseFloat(document.getElementById('documentWidth').value);
			let documentHeight = parseFloat(document.getElementById('documentHeight').value);

			let pdf = new jsPDF({
				orientation: 'portrait',
				unit: 'in',
				format: [documentWidth, documentHeight]
			});

			documentWidth = pdf.internal.pageSize.width;
			documentHeight = pdf.internal.pageSize.height;

			pdf.addImage(template, templateFileType, 0, 0, documentWidth, documentHeight);

			for (let i = 1; i < qrCodes + 1; i++)
			{
				let size = parseFloat(document.getElementById('qrCodeSize-' + i).value);
				let x = parseFloat(document.getElementById('qrCodeX-' + i).value);
				let y = parseFloat(document.getElementById('qrCodeY-' + i).value);
				pdf.addImage(qrcode, 'png', x, y, size, size);
			}

			let filename = document.getElementById("variant-" + i + "-name").value + '.pdf';
			pdf.save(filename);
		}
	}

</script>

</body>
</html>