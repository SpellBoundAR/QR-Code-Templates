<!DOCTYPE html>
<html>
<body>

<h1>QR Code Inserter</h1>

<div id="documentSetup" class="container">
	<p><b>Document Setup</b></p>
	<label for="documentWidth">Width</label><br>
	<input type="number" step="0.01" min="0" id="documentWidth"><br>
	<label for="documentHeight">Height</label><br>
	<input type="number" step="0.01" min="0" id="documentHeight"><br>
	<input type="file" id="file" name="file" onchange="previewFile()"><br>
</div>

<div id="variants" class="container">
	<p><b>Variants</b></p>
	<button type="button" onclick="addVariant()">Add Export Variant</button><br>
</div>

<div id="qrCodePlacements" class="container">
	<p><b>Placements</b></p>
	<button type="button" onclick="addQRCode()">Add QR Code Placement</button><br>
</div>

<div class="container">
	<button type="button" onclick="refresh()">Refresh</button>
	<button type="button" onclick="download()">Download</button>
</div>

<div id="page">
	<img id="preview" src="" alt="Image preview...">
</div>

<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>

<style>
	
	.container
	{
		background: #ddd;
		padding: 15px;
		margin: 15px;
	}

	.qrCodeContainer
	{
		background: #eee;
		padding: 8px;
		margin: 8px;
	}

	.qrCode
	{
		position: relative;
	}

	#page
	{
		position: relative;
		border: 1px solid black;
		width: 11in;
		height: 8in;
	}

	#preview
	{
		position: relative;
		width: 100%;
		height: 100%;
	}

</style>

<script type="text/javascript">

	document.getElementById('documentWidth').value = 8.5;
	document.getElementById('documentHeight').value = 11;

	let variants = 0;
	let qrCodes = 0;

	function addVariant()
	{
		variants++;
		let id = variants;
		let content = '<div id="variant-' + id + '" class="qrCodeContainer">';
		content += '<label for="variant-' + id + '-name">Name</label>'
		content += '<input type="text" id="variant-' + id + '-name"><br>'
		content += '<label for="variant-' + id + '-data">Data</label>';
		content += '<input type="text" id="variant-' + id + '-data" name="variant-' + id + '-data">';
		content += '<button type="button" onclick="generate(' + id + ')">Generate QR Code</button>';
		content += '<div id="variant-' + id + '-source"></div>';
		content += '</div>'
		document.getElementById('variants').innerHTML += content;
	}

	function addQRCode()
	{
		qrCodes++;
		let id = qrCodes;
		let content = '<div id="qrCodePlacement-' + id + '" class="qrCodeContainer">';
		content += '<label for="qrCodeSize-' + id + '">Size (inches)</label>';
		content += '<input type="number" step="0.01" min="0" id="qrCodeSize-' + id + '"><br>';
		content += '<label for="qrCodeX-' + id + '">X: </label>';
		content += '<input type="number" step="0.01" min="0" id="qrCodeX-' + id + '"><br>';
		content += '<label for="qrCodeY-' + id + '">Y: </label>';
		content += '<input type="number" step="0.01" min="0" id="qrCodeY-' + id + '"><br>';
		content += '</div>'
		document.getElementById('qrCodePlacements').innerHTML += content;
	}

	function generate(id)
	{
		let dataID = "variant-" + id + "-data";
		let data = document.getElementById(dataID).value;
		let parentID = "variant-" + id + "-source";

		var parent = document.getElementById(parentID);
		parent.innerHTML = "";

		let qrCodeRaw = new QRCode(parent, {
			text: data,
			width: 128,
			height: 128,
			colorDark : "#111",
			colorLight : "#fff",
			correctLevel : QRCode.CorrectLevel.H
		});
	}

	function previewFile()
	{
		var preview = document.getElementById('preview');
		var file    = document.querySelector('input[type=file]').files[0];
		var reader  = new FileReader();

		reader.onloadend = function ()
		{
			preview.src = reader.result;
		}

		if (file)
		{
			reader.readAsDataURL(file);
		} 
		else preview.src = "";
	}

	function refresh()
	{
		let documentWidth = parseFloat(document.getElementById('documentWidth').value);
		let documentHeight = parseFloat(document.getElementById('documentHeight').value);

		let page = document.getElementById("page")
		page.style.width = documentWidth + "in";
		page.style.height = documentHeight + "in";

		let src = document.querySelector('#variant-1-source img').getAttribute("src");

		for (let i = 1; i < qrCodes + 1; i++)
		{
			let id = "qrCode-" + i;
			var element = document.getElementById(id);
			if (element !== null && element !== undefined)
			{
				element.parentNode.removeChild(element);
			}
		}

		for (let i = 1; i < qrCodes + 1; i++)
		{
			let id = "qrCode-" + i;
			let content = '<img id="' + id + '" src="' + src + '" alt="QR Code">';
			let size = document.getElementById('qrCodeSize-' + i).value;
			let x = document.getElementById('qrCodeX-' + i).value;
			let y = document.getElementById('qrCodeY-' + i).value;
			document.getElementById('page').innerHTML += content;
			document.getElementById(id).style.position = "absolute";
			document.getElementById(id).style.left = x + "in";
			document.getElementById(id).style.top = y + "in";
			document.getElementById(id).style.width = size + "in";
			document.getElementById(id).style.height = size + "in";
		}
	}

	function download()
	{
		let template = new Image();
		template.src = document.getElementById('preview').getAttribute("src");
		let templateFileType = template.src.split('.').pop();

		for (let i = 1; i < variants + 1; i++)
		{
			let qrcode = new Image();
			qrcode.src = document.querySelector('#variant-' + i + '-source img').getAttribute("src");

			let documentWidth = parseFloat(document.getElementById('documentWidth').value);
			let documentHeight = parseFloat(document.getElementById('documentHeight').value);

			let pdf = new jsPDF({
				orientation: 'portrait',
				unit: 'in',
				format: [documentWidth, documentHeight]
			});

			documentWidth = pdf.internal.pageSize.width;
			documentHeight = pdf.internal.pageSize.height;

			pdf.addImage(template, templateFileType, 0, 0, documentWidth, documentHeight);

			for (let i = 1; i < qrCodes + 1; i++)
			{
				let size = parseFloat(document.getElementById('qrCodeSize-' + i).value);
				let x = parseFloat(document.getElementById('qrCodeX-' + i).value);
				let y = parseFloat(document.getElementById('qrCodeY-' + i).value);
				pdf.addImage(qrcode, 'png', x, y, size, size);
			}

			let filename = document.getElementById("variant-" + i + "-name").value + '.pdf';
			pdf.save(filename);
		}
	}

</script>

</body>
</html>